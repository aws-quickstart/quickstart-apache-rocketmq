// We need to work around Step numbers here if we are going to potentially exclude the AMI subscription
=== Sign in to your AWS account

. Sign in to your AWS account at https://aws.amazon.com with an IAM user role that has the necessary permissions. For details, see link:#_planning_the_deployment[Planning the deployment] earlier in this guide.
. Make sure that your AWS account is configured correctly, as discussed in the link:#_technical_requirements[Technical requirements] section.

// Optional based on Marketplace listing. Not to be edited
ifdef::marketplace_subscription[]
=== Subscribe to the {partner-product-short-name} AMI

This Quick Start requires a subscription to the AMI for {partner-product-short-name} in AWS Marketplace.

. Sign in to your AWS account.
. Open the page for the {marketplace_listing_url}[{partner-product-short-name} AMI in AWS Marketplace^], and then choose *Continue to Subscribe*.
. Review the terms and conditions for software usage, and then choose *Accept Terms*. +
  A confirmation page loads, and an email confirmation is sent to the account owner. For detailed subscription instructions, see the https://aws.amazon.com/marketplace/help/200799470[AWS Marketplace documentation^].

. When the subscription process is complete, exit out of AWS Marketplace without further action. *Do not* provision the software from AWS Marketplace—the Quick Start deploys the AMI for you.
endif::marketplace_subscription[]
// \Not to be edited

=== Launch the Quick Start
// Adapt the following warning to your Quick Start.
WARNING: If you’re deploying {partner-product-short-name} into an existing VPC, make sure that your VPC has two private subnets in different Availability Zones for the workload instances and that the subnets aren’t shared. This Quick Start doesn’t support https://docs.aws.amazon.com/vpc/latest/userguide/vpc-sharing.html[shared subnets^]. These subnets require https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html[NAT gateways^] in their route tables to allow the instances to download packages and software without exposing them to the internet. Also make sure that the domain name option in the DHCP options is configured as explained in http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_DHCP_Options.html[DHCP options sets^]. You provide your VPC settings when you launch the Quick Start.

Each deployment takes about {deployment_time} to complete.

. Sign in to your AWS account, and choose one of the following options to launch the AWS CloudFormation template. For help with choosing an option, see link:#_deployment_options[Deployment options] earlier in this guide.

[cols=2*]
|===
^|https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/template?stackName=ApacheRocketMQ&templateURL=https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.master.yaml[Deploy {partner-product-short-name} into a new VPC on AWS^]
^|https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.master.yaml[View template^]

^|https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/template?stackName=ApacheRocketMQ&templateURL=https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.yaml[Deploy {partner-product-short-name} into an existing VPC on AWS^]
^|https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.yaml[View template^]
|===

[start=2]
. Check the AWS Region that’s displayed in the upper-right corner of the navigation bar, and change it if necessary. This Region is where the network infrastructure for {partner-product-short-name} is built. The template is launched in the {default_deployment_region} Region by default. For other choices, see link:#_supported_regions[Supported Regions] earlier in this guide.

[start=3]
. On the *Create stack* page, keep the default setting for the template URL, and then choose *Next*.
. On the *Specify stack details* page, change the stack name if needed. Review the parameters for the template. Provide values for the parameters that require input. For all other parameters, review the default settings and customize them as necessary. For details on each parameter, see the link:#_parameter_reference[Parameter reference] section of this guide. When you finish reviewing and customizing the parameters, choose *Next*.


=== Use Apache RocketMQ
==== Apache RocketMQ deploys on EC2 with directory instructions:
NameServer
[cols=3*]
|===
^|
^|Directory
^|Description

^|1
^|/home/ec2-user/rocketmq-deploy/
^|Apache RocketMQ installation directory

^|2
^|/home/ec2-user/rocketmq-deploy/rocketmq-all-4.7.1-bin-release
or
/home/ec2-user/rocketmq-deploy/rocketmq-all-4. 8. 0-bin-release
^|Apache RocketMQ's application directory

^|3
^|/home/ec2-user/rocketmq-deploy/install.log
^|The installation log for the deployment script, which can be viewed if there is an error

^|4
^|/home/ec2-user/rocketmq-deploy/rocketmq-console-ng-1.0.0.jar
^|App for Apache RocketMQ   Console (only exist on Nameserver instances)
|===

Broker
[cols=3*]
|===
^|
^|Directory
^|Description

^|1
^|/home/ec2-user/rocketmq-deploy/
^|Apache RocketMQ installation directory

^|2
^|/home/ec2-user/rocketmq-deploy/rocketmq-all-4.7.1-bin-release
or
/home/ec2-user/rocketmq-deploy/rocketmq-all-4. 8. 0-bin-release
^|Apache RocketMQ's application directory

^|3
^|/home/ec2-user/rocketmq-deploy/install.log
^|The installation log for the deployment script, which can be viewed if there is an error

^|4
^|/home/ec2-user/rocketmq-deploy/rocketMQ-config/
^|Profile of the Apache RocketMQ Broker program, automatically generated by the deployment script

^|5
^|/home/ec2-user/rocketmq-deploy/rmqstore
^|Apache RocketMQ's local file storage directory
|===

=== How do I log in to Apache RocketMQ's Nameserver and Broker Node?
. Use the ssh-add command to add pem keypair
Example: ssh-add -k /Users/username/tmp/rocketmq.pem
. Sign in to Bastion Host
Example: ssh -A  ec2-user@ec2-52-80-195-90.cn-north-1.compute.amazonaws.com.cn
. To login to Nameserver or Broker Node from Bastion Host, and how to get an IP from Nameserver or Broker node, log in to ec2 console and click on the corresponding ec2  instance, as shown in the following

image::../images/NameServerIPAddress.png[NameServerAddress,width=100%,height=100%]
Examples:(ec2-user@ip-10-0-136-135) $ ssh 10.0.6.235
Last login: Wed Jan  6 04:55:01 2021 from ip-10-0-136-135.cn-north-1.compute.internal
__|  __|_  )
_|  ( / Amazon Linux 2 AMI
___|\___|___|
https://aws.amazon.com/amazon-linux-2/
[ec2-user@ip-10-0-6-235 ~]$

. Once you're signed in to Nameserver or Broker Node, you can use Apache RocketMQ’s own command-line tools.


=== How to view Web Console from Apache RocketMQ using your browser
The current deployment scenario has Web Console applications installed on each Nameserver's instance, but since Nameserver's instance is running on the private subnet, it is not possible to access the 8080 port of the nameserver Private IP directly through a browser, please follow the steps below to establish an SSH Tunnel to Bastion host and access The Nameserver's Web Console via SSH Tunnel.

. Using the ssh command to establish a ssh connection to Bastion Host, some of the red parameters in the following image need to be replaced with parameters corresponding to the user environment
Command ：ssh -qTfnN -D PORTNUMBER -i KEYPAIR USERNAME@HOSTNAME
Example: ssh -qTfnN -D 40011  -i "rocketMQ.pem" ec2-user@ec2-54-223-36-247.cn-north-1.compute.amazonaws.com.cn
. Once you've set up ssh Tunnel, you'll need to set up proxy in your browser, which has a lot of plug-ins that automatically select Proxy, we are using Switchy Omega as an example in this article.
. To install the SwitchyOmega browser  plug-in, Edge browser please visit this link, Firefox browser access this link, Chrome browser access this link.
. Once the Switchy Omega plug-in is installed, open the plug-in's options page and click on the "New Profile" on the left, as shown in the following image
. Enter the name of New Profile in the pop-up window and click the Create button at the bottom right, as follows:
. Enter the information for Proxy Server, as shown below, and click on the Apple changes at the bottom left, noting that the value for Port needs to be set to the local port where you set up the ssh tunnel, see the number after the first step -D parameter, as shown below:
. Click on the SwitchyOmega plug-in and select the RocketMQ profile you just created, as shown below
. After completing this step above, the browser will send all traffic through the local port 40011 proxy to the Bastion  Host machine.
. Enter the private ip address of any of the deployed Nameservers in your browser plus port 8080 (http://10.0.6.235:8080), and you can find the corresponding instance for the nameserver via EC2 Console and find the corresponding IP address, as shown below
. The browser should be able to display the deployed RocketMQ cluster properly, as shown in the following image:

























