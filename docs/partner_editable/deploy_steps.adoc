// We need to work around Step numbers here if we are going to potentially exclude the AMI subscription
=== Sign in to your AWS account

. Sign in to your AWS account at https://aws.amazon.com with an IAM user role that has the necessary permissions. For details, see link:#_planning_the_deployment[Planning the deployment] earlier in this guide.
. Make sure that your AWS account is configured correctly, as discussed in the link:#_technical_requirements[Technical requirements] section.

// Optional based on Marketplace listing. Not to be edited
ifdef::marketplace_subscription[]
=== Subscribe to the {partner-product-short-name} AMI

This Quick Start requires a subscription to the AMI for {partner-product-short-name} in AWS Marketplace.

. Sign in to your AWS account.
. Open the page for the {marketplace_listing_url}[{partner-product-short-name} AMI in AWS Marketplace^], and then choose *Continue to Subscribe*.
. Review the terms and conditions for software usage, and then choose *Accept Terms*. +
  A confirmation page loads, and an email confirmation is sent to the account owner. For detailed subscription instructions, see the https://aws.amazon.com/marketplace/help/200799470[AWS Marketplace documentation^].

. When the subscription process is complete, exit out of AWS Marketplace without further action. *Do not* provision the software from AWS Marketplace—the Quick Start deploys the AMI for you.
endif::marketplace_subscription[]
// \Not to be edited

=== Launch the Quick Start
// Adapt the following warning to your Quick Start.
WARNING: If you’re deploying {partner-product-short-name} into an existing VPC, make sure that your VPC has two private subnets in different Availability Zones for the workload instances and that the subnets aren’t shared. This Quick Start doesn’t support https://docs.aws.amazon.com/vpc/latest/userguide/vpc-sharing.html[shared subnets^]. These subnets require https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html[NAT gateways^] in their route tables to allow the instances to download packages and software without exposing them to the internet. Also make sure that the domain name option in the DHCP options is configured as explained in http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_DHCP_Options.html[DHCP options sets^]. You provide your VPC settings when you launch the Quick Start.

Each deployment takes about {deployment_time} to complete.

. Sign in to your AWS account, and choose one of the following options to launch the AWS CloudFormation template. For help with choosing an option, see link:#_deployment_options[Deployment options] earlier in this guide.

[cols=2*]
|===
^|https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/template?stackName=ApacheRocketMQ&templateURL=https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.master.yaml[Deploy {partner-product-short-name} into a new VPC on AWS^]
^|https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.master.yaml[View template^]

^|https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/template?stackName=ApacheRocketMQ&templateURL=https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.yaml[Deploy {partner-product-short-name} into an existing VPC on AWS^]
^|https://aws-quickstart.s3.amazonaws.com/quickstart-apache-rocketmq/templates/rocketmq.yaml[View template^]
|===

[start=2]
. Check the AWS Region that’s displayed in the upper-right corner of the navigation bar, and change it if necessary. This Region is where the network infrastructure for {partner-product-short-name} is built. The template is launched in the {default_deployment_region} Region by default. For other choices, see link:#_supported_regions[Supported Regions] earlier in this guide.

[start=3]
. On the *Create stack* page, keep the default setting for the template URL, and then choose *Next*.
. On the *Specify stack details* page, change the stack name if needed. Review the parameters for the template. Provide values for the parameters that require input. For all other parameters, review the default settings and customize them as necessary. For details on each parameter, see the link:#_parameter_reference[Parameter reference] section of this guide. When you finish reviewing and customizing the parameters, choose *Next*.


=== Use Apache RocketMQ
==== Apache RocketMQ deploys on EC2 with directory instructions:
NameServer
[cols=3*]
|===
^|
^|Directory
^|Description

^|1
^|/home/ec2-user/rocketmq-deploy/
^|Apache RocketMQ installation directory

^|2
^|/home/ec2-user/rocketmq-deploy/rocketmq-all-4.7.1-bin-release
or
/home/ec2-user/rocketmq-deploy/rocketmq-all-4. 8. 0-bin-release
^|Apache RocketMQ's application directory

^|3
^|/home/ec2-user/rocketmq-deploy/install.log
^|The installation log for the deployment script, which can be viewed if there is an error

^|4
^|/home/ec2-user/rocketmq-deploy/rocketmq-console-ng-1.0.0.jar
^|App for Apache RocketMQ   Console (only exist on Nameserver instances)
|===

Broker
[cols=3*]
|===
^|
^|Directory
^|Description

^|1
^|/home/ec2-user/rocketmq-deploy/
^|Apache RocketMQ installation directory

^|2
^|/home/ec2-user/rocketmq-deploy/rocketmq-all-4.7.1-bin-release
or
/home/ec2-user/rocketmq-deploy/rocketmq-all-4. 8. 0-bin-release
^|Apache RocketMQ's application directory

^|3
^|/home/ec2-user/rocketmq-deploy/install.log
^|The installation log for the deployment script, which can be viewed if there is an error

^|4
^|/home/ec2-user/rocketmq-deploy/rocketMQ-config/
^|Profile of the Apache RocketMQ Broker program, automatically generated by the deployment script

^|5
^|/home/ec2-user/rocketmq-deploy/rmqstore
^|Apache RocketMQ's local file storage directory
|===

=== How do I log in to Apache RocketMQ's Nameserver and Broker Node?
. Use the ssh-add command to add pem keypair
Example: ssh-add -k /Users/username/tmp/rocketmq.pem
. Sign in to Bastion Host
Example: ssh -A  ec2-user@ec2-52-80-195-90.cn-north-1.compute.amazonaws.com.cn
. To login to Nameserver or Broker Node from Bastion Host, and how to get an IP from Nameserver or Broker node, log in to ec2 console and click on the corresponding ec2  instance, as shown in the following

image::../images/NameServerIPAddress.png[NameServerAddress,width=100%,height=100%]
Examples:(ec2-user@ip-10-0-136-135) $ ssh 10.0.6.235
Last login: Wed Jan  6 04:55:01 2021 from ip-10-0-136-135.cn-north-1.compute.internal
__|  __|_  )
_|  ( / Amazon Linux 2 AMI
___|\___|___|
https://aws.amazon.com/amazon-linux-2/
[ec2-user@ip-10-0-6-235 ~]$

. Once you're signed in to Nameserver or Broker Node, you can use Apache RocketMQ’s own command-line tools.


=== How to view Web Console from Apache RocketMQ using your browser
The current deployment scenario has Web Console applications installed on each Nameserver's instance, but since Nameserver's instance is running on the private subnet, it is not possible to access the 8080 port of the nameserver Private IP directly through a browser, please follow the steps below to establish an SSH Tunnel to Bastion host and access The Nameserver's Web Console via SSH Tunnel.

. Using the ssh command to establish a ssh connection to Bastion Host, some of the red parameters in the following image need to be replaced with parameters corresponding to the user environment
Command ：ssh -qTfnN -D PORTNUMBER -i KEYPAIR USERNAME@HOSTNAME
Example: ssh -qTfnN -D 40011  -i "rocketMQ.pem" ec2-user@ec2-54-223-36-247.cn-north-1.compute.amazonaws.com.cn
. Once you've set up ssh Tunnel, you'll need to set up proxy in your browser, which has a lot of plug-ins that automatically select Proxy, we are using Switchy Omega as an example in this article.
. To install the SwitchyOmega browser  plug-in, Edge browser please visit this link, Firefox browser access this link, Chrome browser access this link.
. Once the Switchy Omega plug-in is installed, open the plug-in's options page and click on the "New Profile" on the left, as shown in the following image
. Enter the name of New Profile in the pop-up window and click the Create button at the bottom right, as follows:
. Enter the information for Proxy Server, as shown below, and click on the Apple changes at the bottom left, noting that the value for Port needs to be set to the local port where you set up the ssh tunnel, see the number after the first step -D parameter, as shown below:
. Click on the SwitchyOmega plug-in and select the RocketMQ profile you just created, as shown below
. After completing this step above, the browser will send all traffic through the local port 40011 proxy to the Bastion  Host machine.
. Enter the private ip address of any of the deployed Nameservers in your browser plus port 8080 (http://10.0.6.235:8080), and you can find the corresponding instance for the nameserver via EC2 Console and find the corresponding IP address, as shown below
. The browser should be able to display the deployed RocketMQ cluster properly, as shown in the following image:



=== CloudFormation Parameter

==== Deploy Apache RocketMQ to the new VPC
[cols=4*]
|=====
^|The parameter label
^|The name of the argument
^|The default Value
^|Description

^|Availability Zones
^|AvailabilityZones
^|Required
^|A list of availability zones. The logical order that you specify is preserved. This deployment enables the use of 2 or 3 available zones.  When you're done selecting, make sure that the parameter “Number of Availability Zones” is the same as your selection here.

^|Number of Availability Zones
^|NumberOfAZs
^|[red]#Required#
^|The number of availability zones (2 or 3) to use in the VPC. This number must be consistent with your selection in the Availability Zones parameter;

^|VPC CIDR
^|VPCCIDR
^|10.0.0.0/16
^|The CIDR block of the VPC to create.

^|Private Subnet 1 CIDR
^|PrivateSubnet1CIDR
^|10.0.0.0/19
^|The CIDR block of the private subnet in Availability Zone 1 can be used.

^|Private Subnet 2 CIDR
^|PrivateSubnet2CIDR
^|10.0.32.0/19
^|The CIDR block of the private subnet in Availability Zone 2 can be used.

^|Private Subnet 3 CIDR
^|PrivateSubnet3CIDR
^|10.0.64.0/19
^|The CIDR block of the private subnet in Availability Zone 3 can be used.

^|Public Subnet 1 CIDR
^|PublicSubnet1CIDR
^|10.0.128.0/20
^|The CIDR block of the public subnet in Availability Zone 1 can be used.

^|Public Subnet 2 CIDR
^|PublicSubnet2CIDR
^|10.0.144.0/20
^|The CIDR block of the public subnet in Availability Zone 2 can be used.

^|Public Subnet 3 CIDR
^|PublicSubnet3CIDR
^|10.0.160.0/20
^|The CIDR block of the public subnet in Availability Zone 3 can be used.

^|Allowed Bastion External Access CIDR
^|RemoteAccessCIDR
^|[red]#Required#
^|The CIDR IP range that allows external SSH access to the bastion host. We recommend that you set this value to a trusted IP range. For example, you might want to grant access only to corporate network IP segments.   If all external hosts are allowed access, you can set it to 0.0.0.0/0

^|Key Name
^|KeyPairName
^|[red]#Required#
^|EC2 key pair, used to connect EC2 instances.

^|Bastion AMI Operating System
^|BastionAMIOS
^|AmazonLinuxHVM
^|You can choose Amazon Linux, CentOS, or Ubuntu Server. If you select CentOS, make sure you are subscribed to CentOS AMI in AWS Marketplace first.

^|Bastion Instance Type
^|BastionInstanceType
^|t2.micro
^|The EC2 real-world type of the bastion host instance.

^|Number of Bastion Hosts
^|NumBastionHosts
^|1
^|Number of bastion hosts. Auto Scaling will ensure that you always maintain this number of bastion host.

^|Number of Apache RocketMQ NameServer Cluster Node
^|NameServerClusterCount
^|2
^|Select the number of Apache RocketMQ Nameserver nodes to deploy.

^|Number of Apache RocketMQ Broker Cluster Node
^|BrokerClusterCount
^|3
^|Select the number of Apache RocketMQ Broker nodes to deploy.

^|IOPS
^|Iops
^|100
^|If you select the io1 volume type, this setting is IOPS for the EBS volume, otherwise this option is ignored.

^|RocketMQ Version
^|RocketMQVersion
^|4.7.1
^|Select the software version of Apache RocketMQ for deployment and currently supports 4.7.1 and 4.8.0

^|NameServer Intance type
^|NameServerInstanceType
^|m5.large
^|The EC2 instance type of the Nameserver node

^|Broker Node Instance Type
^|BrokerNodeInstanceType
^|m5.xlarge
^|Broker node EC2 instance type

^|Apache RocketMQ flush Disk Type
^|FlushDiskType
^|ASYNC_FLUSH
^|Apache RocketMQ Flush Disk type (ASYNC_FLUSH or SYNC_FLUSH).

^|Volume Size
^|VolumeType
^|Gp2
^|The type of volume for the Amazon EBS (data) volume to mount to the RocketMQ node (gp2 or io1).

^|Quick Start S3 Bucket Name
^|QSS3BucketName
^|aws-cnquickstart
^|The S3 storage bucket where the resource is located. Do not change this selection except that you have manually updated the CloudFormation template of RocketMQ Quick Deployment and uploaded it to your own bucket.

^|Quick Start S3 Key Prefix
^|QSS3KeyPrefix
^|quickstart-rocketmq/
^|S3 prefix. Do not change this option except that you have manually updated the CloudFormation template and change the prefix.
|===

=== Deploy Apache RocketMQ to the existing VPC

|=====
[cols=4*]
|=====
^|The parameter label
^|The name of the argument
^|The default Value
^|Description

^|VPC
^|VPC
^|[red]#Required#
^|You want to deploy to an existing VPC ID (for example, vpc0343606e).

^|Primary Node Subnet
^|PrimaryNodeSubnet
^|[red]#Required#
^|The Subnet ID (for example,  subnet-a0246dcd) is present in the VPC to which the main RocketMQ node is deployed.  This subnet needs to be in the VPC of your choice.

^|Secondary0 Node Subnet
^|Secondary0NodeSubnet
^|[red]#Required#
^|The subnet ID where the first secondary RocketMQ node in the replica set is located.  This subnet needs to exist in the selected VPC.

^|Secondary1 Node Subnet
^|Secondary1NodeSubnet
^|[red]#Required#
^|The ID of the subnet where the second secondary RocketMQ node in the replica set is located. This subnet needs to exist in the selected VPC.

^|Bastion Security Group ID
^|BastionSecurityGroupID
^|[red]#Required#
^|ID (eg. sg7f16e910) for the security group of the fortress machine. This security group needs to exist in the VPC of your choice.

^|Key Name
^|KeyPairName
^|[red]#Required#
^|Key pair, used to connect EC2 instances.

^|Quick Start S3 Bucket Name
^|QSS3BucketName
^|aws-quickstart
^|The S3 storage bucket where the resource is located. Do not change this selection except that you have manually updated the CloudFormation template of RocketMQ Quick Deployment and uploaded it to your own bucket.

^|Quick Start S3 Key Prefix
^|QSS3KeyPrefix
^|quickstart-apache-rocketmq/
^|S3 prefix. Do not change this option except that you have manually updated the CloudFormation template and change the prefix.

^|Quick Start S3 bucket region
^|QSS3BucketRegion
^|us-east-1
^|The region for S3bucket.   Do not change this option except that you have manually updated the CloudFormation and stored it under the bucket of different regions.

^|BrokerClusterCount
^|BrokerClusterCount
^|3
^|The number of Apache RocketMQ Broker nodes deployed

^|BrokerNodeInstanceType
^|BrokerNodeInstanceType
^|m5.xlarge
^|The type of EC2 Instance of the Broker node

^|FlushDiskType
^|FlushDiskType
^|ASYNC_FLUSH
^|Disk flush method of Apache RocketMQ, currently supports ASYNC_FLUSH and SYNC_FLUSH

^|Iops
^|Iops
^|100
^|If you select the io1 volume type, this setting is IOPS for the EBS volume, otherwise this selection is ignored.

^|NameServerClusterCount
^|NameServerClusterCount
^|2
^|Select the number of Apache RocketMQ Nameserver nodes to deploy.

^|NameServerInstanceType
^|NameServerInstanceType
^|m5.large
^|The EC2 instance type of the NameServer node

^|RocketMQVersion
^|RocketMQVersion
^|4.7.1
^|Select the software version of Apache RocketMQ for deployment and currently supports 4 .7.1 and 4.8.0

^|VolumeSize
^|VolumeSize
^|400
^|The size of the Amazon EBS (data) volume (in GB) to mount to all RocketMQ nodes.

^|VolumeType
^|VolumeType
^|gp2
^|The type of volume for the Amazon EBS (data) volume to mount to the RocketMQ node (gp2 or io1).
|===

























